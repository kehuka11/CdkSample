# CDKサンプル

## 動かし方

### 前提

各バージョン

```
npm: 22.0.0
cdk: 2.149.0
typescript: 5.5.3
```

#### CDK install

```
npm install [-g] aws-cdk
```

```
cdk --version
```
バージョンが表示されていればOK

特定のディレクトリでしか使用しない場合は、gオプション付けない

#### typescript install

```
npm install -g typescript
```

```
tsc -v
```

バージョンが表示されていればOK

### CloudFormationテンプレート作成

l2 or l1 sampleフォルダ配下で以下コマンド実施

```
cdk synth
```

アクティブディレクトリ配下にcdk.outフォルダが作成されており、その中に*.template.jsが作成される

### cdkデプロイ

```
cdk deploy --profile [profileName]
```

デプロイ時はProfile指定するように注意。

### テスト実行

```
cd l2 or l1 _sample
npm test
```

*.test.tsファイルが実行される。

## CDK学習

### L1 or L2 constructor使用

#### L1

L1はCloudFormationのテンプレートを直接作るようなソースになる。

##### L1メリット
・細かいとこも含めてコードに落とすので、設定ミスが出にくい。（AWS ManagedServiceに必要な設定を理解している前提だが）
・CloudFormationテンプレートを作成した際の差分が出にくい

##### L1デメリット
・コードの記載量が多くなるため、可読性が下がる、保守コスト高くなる。

#### L2

L2はL1に比べより抽象的にソースを書くことができる。

##### L2メリット
・細かい設定をいちいち書かなくても動くようにデフォルトの設定が入る。
・コードの記載量が少なくなり、可読性と保守性が上がる。

##### L2デメリット
・設定すべき部分を全て知らなくても動くリソースを作れる一方で、意図してない設定が適応されている可能性があるので、テンプレート作成時にテストして確認してないと危険
・全てを確認しているわけではないが、設定によっては細かい部分を設定できない可能性がある。

### CloudFormationの知識が必要
最終的にCloudFormationが作成されるので、ここの知識ないと意図しない設定が入ったり、デプロイ時にエラーになった時のエラーがどこの部分（ソースレベル、テンプレート）なのか切り分けが難しいように感じた。
特に、初めてL2使って書く場合は、1度作成されたテンプレートの設定が意図しているものか必ずチェックした方がテストコード＋テンプレート目視チェック（初めてCDK使用する場合、テスト観点が抜けている可能性があるため）

### テストコード

テストはテンプレートに対して、リソースの数やプロパティの設定が正しいかを確認するアサーションテストとスナップショットと作成するテンプレートに差分がないかをテストする2種類がある。
基本的にどちらかだけでなく、両方実施する方がいい。（スナップショットテストは一度コード書いておけば、変更することはほとんどないと思うので、実質アサーションテストだけ保守コストが発生する）

#### アサーションテスト
CDKのスタックからテンプレートを作成して、テンプレートに記載してあるプロパティやリソース数が意図したものになっているかをテストする。

test/assert配下のテストコード参照

#### スナップショット
初めにテスト実行した際にスナップショットが作成される。2回目以降にスナップショットとテンプレートの作成した結果が合っているかをチェックする。
リファクタした際に、テンプレートが既存のものとずれていないかのチェックに使用する。

test/snapshot配下のテストコード参照

### Git管理
SecretManagerなど秘匿情報を扱う ManagedServiceを作成する際に、直接値をベタ書きすると、Git上にアップしてしまうので、工夫が必要。

#### 秘匿情報の扱い

##### 暗号化ツール使用
暗号化ツールを使用する。（複合鍵の管理どうするか問題があるので、難しそう）

##### 環境変数化
環境変数化しておき、テンプレート作成タイミングでバインドさせる。値自体はCICDツールによって管理が分かれる。
GithubActionsを使用する場合は、GitSecretで管理がいいかな
Jenkins使う場合は、どうする？

##### 管理しない
秘匿情報を管理するような ManagedServiceは手動で作成しておき、コード化しないようにする。
今回のサンプルでは、既に作成しているSecretManagerからシークレット情報を取得するようにしている。（ただ実際にデプロイして確認したわけではないので、正しくバインドされるかは未検証）

